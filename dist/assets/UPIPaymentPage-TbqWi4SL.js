import{r as e,j as s}from"./ui-DmSYmwlh.js";import{u as t,n as a,b as r,a as n,t as i,d as c,B as d,g as o,s as m}from"./index-sG1ZoleV.js";import{S as l,C as x,a as p,b as u,c as h}from"./separator-C5Dcbw9Z.js";import{Q as f,S as j,R as g,M as N,C as y}from"./browser-BjRqf1-l.js";import"./vendor-CTYTkcnE.js";import"./supabase-CLG-Fze1.js";function b(){const b=t(),w=a(),{user:v}=r(),{items:I,clearCart:P}=n(),[C,k]=e.useState(""),[_,F]=e.useState(null),[S,D]=e.useState(!1),[U,O]=e.useState("pending"),[$,R]=e.useState("");e.useRef(null),e.useEffect(()=>{if(w.state?.paymentData){const e=w.state.paymentData;F(e),R(e.orderId),e.preloadedQRCode,A(e.orderId,e.amount)}else b("/checkout")},[w.state,b]);const A=async(e,s)=>{try{const t=`upi://pay?pa=hrejuh@upi&pn=Cigarro&am=${s}&tid=${e}&tn=${e}`,a=await f.toDataURL(t,{width:256,margin:2,color:{dark:"#000000",light:"#FFFFFF"}});k(a)}catch(t){console.error("Error generating QR code:",t),i.error("Failed to generate QR code")}},Q=async()=>{D(!0);try{await new Promise(e=>setTimeout(e,2e3));if(Math.random()>.3)await L();else{window.confirm("Did you complete the payment in your UPI app? Click OK if payment was successful.")?await L():(i.error("Payment not completed. Please try again."),D(!1))}}catch(e){console.error("Payment verification failed:",e),O("failed"),i.error("Payment verification failed"),D(!1)}},L=async()=>{if(_&&v)try{const e={id:_.orderId,user_id:v.id,status:"processing",subtotal:_.originalAmount,tax:0,shipping:0,total:_.amount,discount:_.discount,payment_method:"UPI",payment_confirmed:!0,payment_confirmed_at:(new Date).toISOString(),shipping_name:`${_.shippingInfo.firstName} ${_.shippingInfo.lastName}`,shipping_address:_.shippingInfo.address,shipping_city:_.shippingInfo.city,shipping_state:_.shippingInfo.state,shipping_zip_code:_.shippingInfo.zipCode,shipping_country:_.shippingInfo.country||"India",estimated_delivery:new Date(Date.now()+6048e5).toISOString()},{data:s,error:t}=await m.from("orders").insert(e).select().single();if(t)throw t;const a=_.items.map(e=>({order_id:s.id,product_id:e.id,product_name:e.name,product_brand:e.brand,product_price:e.price,product_image:e.gallery_images?.[0]||e.image,quantity:e.quantity})),{error:r}=await m.from("order_items").insert(a);if(r)throw r;await P(),O("success"),i.success("Payment confirmed! Order is now being processed."),setTimeout(()=>{b("/orders")},3e3)}catch(e){console.error("Failed to process order:",e),O("failed"),i.error("Failed to process order. Please contact support.")}finally{D(!1)}};return _?"success"===U?s.jsx("div",{className:"min-h-screen bg-background py-12",style:{transform:"scale(1.8)",transformOrigin:"top left",width:"55.56%",marginBottom:"80%"},children:s.jsx("div",{className:"max-w-2xl mx-auto px-4 sm:px-6 lg:px-8",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mb-6",children:s.jsx(c,{className:"w-8 h-8 text-white"})}),s.jsx("h1",{className:"font-serif-premium text-3xl text-foreground mb-4",children:"Order Confirmed!"}),s.jsx("p",{className:"font-sans-premium text-muted-foreground mb-8",children:"Your payment has been confirmed and your order is now being processed."}),s.jsxs("div",{className:"glass-card p-6 mb-8",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Order ID"}),s.jsx("span",{className:"font-sans-premium text-foreground",children:$})]}),s.jsx(l,{className:"my-4"}),s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Amount Paid"}),s.jsxs("span",{className:"font-serif-premium text-xl text-accent",children:["₹",_.amount.toFixed(2)]})]}),_.discount>0&&s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"my-4"}),s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Discount Applied"}),s.jsxs("span",{className:"font-serif-premium text-green-600",children:["-₹",_.discount.toFixed(2)]})]})]})]}),s.jsx(d,{onClick:()=>b("/orders"),className:"bg-accent text-accent-foreground hover:bg-accent/90 mr-4",children:"View Orders"}),s.jsx(d,{variant:"outline",onClick:()=>b("/"),children:"Continue Shopping"})]})})}):s.jsx("div",{className:"min-h-screen bg-background py-12",style:{transform:"scale(1.8)",transformOrigin:"top left",width:"55.56%",marginBottom:"80%"},children:s.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[s.jsxs("div",{className:"text-center mb-8",children:[s.jsx("h1",{className:"font-serif-premium text-2xl text-foreground",children:"UPI Payment"}),s.jsx("p",{className:"text-muted-foreground",children:"Complete your payment securely"})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsxs(x,{className:"glass-card border-border/20",children:[s.jsx(p,{children:s.jsxs(u,{className:"flex items-center space-x-2 font-serif-premium",children:[s.jsx(j,{className:"w-5 h-5 text-accent"}),s.jsx("span",{children:"Pay with UPI App"})]})}),s.jsxs(h,{className:"space-y-4",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Click the button below to open your UPI app and complete the payment."}),s.jsx(d,{onClick:()=>{if(!_)return;const e=`upi://pay?pa=hrejuh@upi&pn=Cigarro&am=${_.amount}&tid=${_.orderId}&tn=${_.orderId}`;window.location.href=e,setTimeout(()=>{Q()},5e3)},disabled:S,className:"w-full bg-accent text-accent-foreground hover:bg-accent/90",children:S?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(g,{className:"w-4 h-4 animate-spin"}),s.jsx("span",{children:"Processing..."})]}):s.jsxs(s.Fragment,{children:[s.jsx(j,{className:"w-4 h-4 mr-2"}),"Open UPI App"]})}),s.jsx("div",{className:"text-xs text-muted-foreground text-center",children:"Works with Google Pay, PhonePe, Paytm, and other UPI apps"})]})]}),s.jsxs(x,{className:"glass-card border-border/20",children:[s.jsx(p,{children:s.jsxs(u,{className:"flex items-center space-x-2 font-serif-premium",children:[s.jsx(N,{className:"w-5 h-5 text-accent"}),s.jsx("span",{children:"Scan QR Code"})]})}),s.jsxs(h,{className:"space-y-4",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Scan this QR code with any UPI app on your phone to complete the payment."}),s.jsx("div",{className:"flex justify-center",children:C?s.jsx("div",{className:"p-4 bg-white rounded-lg border",children:s.jsx("img",{src:C,alt:"UPI Payment QR Code",className:"w-48 h-48"})}):s.jsx("div",{className:"w-48 h-48 bg-muted rounded-lg flex items-center justify-center",children:s.jsx(g,{className:"w-8 h-8 animate-spin text-muted-foreground"})})}),s.jsxs(d,{variant:"outline",onClick:()=>{if(!_)return;const e=`upi://pay?pa=hrejuh@upi&pn=Cigarro&am=${_.amount}&tid=${_.orderId}&tn=${_.orderId}`;navigator.clipboard.writeText(e),i.success("UPI link copied to clipboard")},className:"w-full",children:[s.jsx(y,{className:"w-4 h-4 mr-2"}),"Copy UPI Link"]}),s.jsx("div",{className:"text-xs text-muted-foreground text-center",children:'After payment, click "Check Payment Status" below'})]})]}),s.jsx(d,{onClick:Q,disabled:S,variant:"outline",className:"w-full",children:S?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(g,{className:"w-4 h-4 animate-spin"}),s.jsx("span",{children:"Checking..."})]}):s.jsxs(s.Fragment,{children:[s.jsx(c,{className:"w-4 h-4 mr-2"}),"Check Payment Status"]})})]}),s.jsx("div",{children:s.jsxs(x,{className:"glass-card border-border/20 sticky top-24",children:[s.jsx(p,{children:s.jsx(u,{className:"font-serif-premium",children:"Order Summary"})}),s.jsxs(h,{className:"space-y-4",children:[s.jsx("div",{className:"space-y-3",children:_.items.map(e=>s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-sans-premium text-sm text-foreground truncate",children:e.name}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Qty: ",e.quantity]})]}),s.jsxs("span",{className:"font-serif-premium text-sm text-accent",children:["₹",(e.price*e.quantity).toFixed(2)]})]},e.id))}),s.jsx(l,{className:"bg-border/20"}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Subtotal"}),s.jsxs("span",{className:"font-sans-premium text-foreground",children:["₹",_.originalAmount.toFixed(2)]})]}),_.discount>0&&s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Lucky Discount"}),s.jsxs("span",{className:"font-sans-premium text-green-600",children:["-₹",_.discount.toFixed(2)]})]}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"font-sans-premium text-muted-foreground",children:"Shipping"}),s.jsx("span",{className:"font-sans-premium text-accent",children:"Free"})]})]}),s.jsx(l,{className:"bg-border/20"}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"font-serif-premium text-lg text-foreground",children:"Total"}),s.jsxs("span",{className:"font-serif-premium text-xl text-accent",children:["₹",_.amount.toFixed(2)]})]}),s.jsx("div",{className:"mt-6 p-3 bg-accent/10 rounded-lg border border-accent/20",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"font-sans-premium text-sm text-foreground",children:"Payment Details"}),s.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Order ID: ",$]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Merchant: Cigarro"}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"UPI ID: hrejuh@upi"})]})}),_.discount>0&&s.jsx("div",{className:"mt-4 p-3 bg-green-50 rounded-lg border border-green-200",children:s.jsxs("div",{className:"text-center",children:[s.jsx(o,{className:"bg-green-100 text-green-800 border-green-300",children:"🎉 Lucky Discount Applied!"}),s.jsxs("p",{className:"text-xs text-green-700 mt-2",children:["You saved ₹",_.discount.toFixed(2)," on this order!"]})]})})]})]})})]})]})}):s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"Loading payment details..."})]})})}export{b as UPIPaymentPage};
